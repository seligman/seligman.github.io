<html><head>
<!--
    Test IPs:
AWS:    3.2.34.0
        2600:1ff2:4000::
Google: 34.80.0.0
        2600:1900:4030::
Azure:  40.126.0.0
        2a01:111:f403:f910::
Private: 127.1.2.7
        ::1
-->
<title>Lookup Cloud IP</title>
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<style>
body {
    background:#272822;
    color:#f8f8f2;
    font-family:Menlo,Monaco,Consolas,monospace;
    font-size:12pt;
}
a {
    color:#a8a8f2;
    text-decoration:none;
}
a:hover{
    color:#a8a8f2;
    text-decoration:underline;
}
input[type=button],input[type=submit],input[type=reset] {
    background-color: #444;
    border: none;
    color: #f8f8f2;
    padding: 2pt 20pt;
    text-decoration: none;
    cursor: pointer;
    font-family: Menlo,Monaco,Consolas,monospace;
    font-size: 12pt;
    -webkit-appearance: none;
}
input[type="text"],input[type="number"],textarea {
    background-color: #000;
    color: #cec;
    font-family: Menlo,Monaco,Consolas,monospace;
    font-size: 12pt;
    border-top-style: hidden;
    border-right-style: hidden;
    border-left-style: hidden;
    border-bottom-style: solid;
    border-bottom-width: 1px;
    border-bottom-color: #a8a8f2;
    padding: 2px;
}
input[type="text"],input[type="number"],textarea:focus {
    outline: none;
}
</style>
<script src="pako.min.js"></script>
<script src="cidr_helper.min.js"></script>
<script src="regions.js"></script>
<script src="private_ips.js"></script>
<script>
function crack_all(value, regions=null, source=null, region=null) {
    value.forEach(x => {
        if (source !== null) {
            x["source"] = source;
        }
        if (region !== null) {
            x["region"] = region;
        }
        if ("ip_prefix" in x) {
            x["ip_prefix"] = crackCidr(x["ip_prefix"]);
        } else {
            x["ipv6_prefix"] = crackCidr(x["ipv6_prefix"]);
        }
        if (regions !== null) {
            if (x["region"] in regions) {
                x["region"] += ", " + regions[x["region"]];
            }
        }
    });
}
crack_all(private_ips, {}, source="Private IP", region="");
crack_all(private_ips6, {}, source="Private IP", region="");
var ipRanges = null;
var left_to_load = 4;
const other_sources = [
    ["cloudflare", "Cloudflare"],
    ["digitalocean", "DigitalOcean"],
    ["facebook", "Facebook"],
    ["hetzner", "Hetzner"],
    ["icloudprov", "iCloud"],
    ["linode", "Linode"],
    ["oracle", "Oracle"],
    ["vultr", "Vultr"],
];
left_to_load += other_sources.length;

function done_loading() {
    left_to_load--;
    if (left_to_load == 0) {
        if (other_ips !== null) {
            crack_all(other_ips);
        }
        if (other_ips6 !== null) {
            crack_all(other_ips6);
        }
        helper = function() {
            document.getElementById('results').innerHTML = lookup(document.getElementById('ip').value);
        };
        document.getElementById('ip').oninput = helper;
        helper();
    }
}

function fetch_error(response) {
    if (!response.ok) {
        throw Error(response.status + " (" + response.statusText + ")");
    }
    return response;
}

function show_error(source, error) {
    document.getElementById("errors").innerHTML += "ERROR: Unable to load " + source + " IP ranges: " + error.message + "<br>"
    done_loading();
}

var aws_ips = null;
var aws_ips6 = null;
fetch("https://raw.githubusercontent.com/seligman/aws-ip-ranges/master/ip-ranges.json")
    .then(fetch_error)
    .then(response => response.json())
    .then(json => {
        ipRanges = json;
        crack_all(ipRanges["prefixes"], aws_regions, source="AWS");
        crack_all(ipRanges["ipv6_prefixes"], aws_regions, source="AWS");
        aws_ips = ipRanges["prefixes"];
        aws_ips6 = ipRanges["ipv6_prefixes"];
        done_loading();
    })
    .catch((error) => {
        aws_ips = null;
        aws_ips6 = null;
        show_error("AWS", error)
    });

var google_ips = null;
var google_ips6 = null;
fetch("https://raw.githubusercontent.com/seligman/cloud_sizes/master/data/raw_google.json.gz")
    .then(fetch_error)
    .then(response => response.arrayBuffer())
    .then(text => {
        text = window.pako.inflate(text);
        text = new TextDecoder().decode(text);
        var data = JSON.parse(text);
        google_ips = [];
        google_ips6 = [];
        data['prefixes'].forEach(x => {
            if ('ipv4Prefix' in x) {
                google_ips.push({
                    "ip_prefix": x['ipv4Prefix'], 
                    "region": x['scope'], 
                    "service": x['service'], 
                })
            } else {
                google_ips6.push({
                    "ipv6_prefix": x['ipv6Prefix'], 
                    "region": x['scope'], 
                    "service": x['service'], 
                })
            }
        });
        crack_all(google_ips, google_regions, source="Google");
        crack_all(google_ips6, google_regions, source="Google");
        done_loading();
    })
    .catch((error) => {
        aws_ips = null;
        aws_ips6 = null;
        show_error("AWS", error)
    });

var azure_ips = null;
var azure_ips6 = null;
fetch("https://raw.githubusercontent.com/seligman/cloud_sizes/master/data/raw_azure.json.gz")
    .then(fetch_error)
    .then(response => response.arrayBuffer())
    .then(text => {
        text = window.pako.inflate(text);
        text = new TextDecoder().decode(text);
        var data = JSON.parse(text);
        azure_ips = [];
        azure_ips6 = [];
        data['values'].forEach(x => {
            x['properties']['addressPrefixes'].forEach(y => {
                if (y.indexOf(":") >= 0) {
                    azure_ips6.push({
                        "ipv6_prefix": y, 
                        "region": x['properties']['region'], 
                        "service": x['properties']['systemService'], 
                    })
                } else {
                    azure_ips.push({
                        "ip_prefix": y, 
                        "region": x['properties']['region'], 
                        "service": x['properties']['systemService'], 
                    })
                }
            });
        });
        crack_all(azure_ips, azure_regions, source="Azure");
        crack_all(azure_ips6, azure_regions, source="Azure");
        done_loading();
    })
    .catch((error) => {
        aws_ips = null;
        aws_ips6 = null;
        show_error("AWS", error)
    });

var other_ips = null;
var other_ips6 = null;
other_sources.forEach(x => {
    var temp_ips = [];
    var temp_ips6 = [];
    fetch("https://raw.githubusercontent.com/seligman/cloud_sizes/master/data/data_" + x[0] + ".json.gz")
        .then(fetch_error)
        .then(response => response.arrayBuffer())
        .then(text => {
            text = window.pako.inflate(text);
            text = new TextDecoder().decode(text);
            var data = JSON.parse(text);
            data['v4'].forEach(ip => {
                temp_ips.push({
                    "ip_prefix": ip, 
                    "region": "",
                    "service": "",
                    "source": x[1], 
                })
            });
            data['v6'].forEach(ip => {
                temp_ips6.push({
                    "ipv6_prefix": ip, 
                    "region": "",
                    "services": "",
                    "source": x[1], 
                })
            });
            if (other_ips === null) {
                other_ips = [];
            }
            if (other_ips6 === null) {
                other_ips6 = [];
            }
            other_ips = other_ips.concat(temp_ips);
            other_ips6 = other_ips6.concat(temp_ips6);
            done_loading();
        })
        .catch((error) => {
            show_error(x[1], error);
        });
});

function lookup(ip) {
    ip = ip.trim();
    if (ip.length == 0) {
        return "-";
    }
    var ret = "";
    var todo = null;
    if (!checkCidr(ip, function(i, v6){
        if (todo === null) {
            todo = []
            if (v6) {
                if (aws_ips6 !== null) { todo = todo.concat(aws_ips6); }
                if (google_ips6 !== null) { todo = todo.concat(google_ips6); }
                if (azure_ips6 !== null) { todo = todo.concat(azure_ips6); }
                if (other_ips6 !== null) { todo = todo.concat(other_ips6); }
                if (private_ips6 !== null) { todo = todo.concat(private_ips6); }
            } else {
                if (aws_ips !== null) { todo = todo.concat(aws_ips); }
                if (google_ips !== null) { todo = todo.concat(google_ips); }
                if (azure_ips !== null) { todo = todo.concat(azure_ips); }
                if (other_ips !== null) { todo = todo.concat(other_ips); }
                if (private_ips !== null) { todo = todo.concat(private_ips); }
            }
        }
        if (i < todo.length) {
            return todo[i][v6 ? 'ipv6_prefix' : 'ip_prefix'];
        } else {
            return null;
        }
    }, function(i, v6) {
        var temp = todo[i][v6 ? 'ipv6_prefix' : 'ip_prefix'];
        ret += "Prefix: " + temp[2] + " <i>(";
        ret += ipToString(temp[0], v6) + " -&gt; " + ipToString(temp[1], v6) + ")</i><br>";
        if (todo[i]['region'].length > 0) {
            ret += "Region: " + todo[i]['region'] + "<br>";
        }
        if (todo[i]['service'].length > 0) {
            ret += "Service: " + todo[i]['service'] + "<br>";
        }
        ret += "Source: " + todo[i]["source"] + "<br>";
        ret += "<br>"
    })) {
        ret = "(invalid IP)";
    }
    if (ret.length==0) {
        ret = "(unknown IP)";
    }
    return ret;
}
</script>
</head>
<body onload="done_loading()">
<p>Enter an IP to lookup which service it comes from:</p>
<input type="text" size="40" id="ip" autocomplete="off" autocorrect="off">
<br><br>
<div id="results">Loading...</div><br>
<div id="errors"></div>
</body>
</html>
