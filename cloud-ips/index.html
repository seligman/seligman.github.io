<html><head>
<!-- -----------------------------------------------------------------------------------------
This uses a database file generated by the utility that maintains the repo at
  https://github.com/seligman/cloud_sizes

If you'd like, there is a sample command line Python implementation of this at:
  https://github.com/seligman/seligman.github.io/blob/master/cloud-ips/lookup_ip_address.py

Some test IPs:
    AWS:    3.2.34.0
            2600:1ff2:4000::
    Google: 34.80.0.0
            2600:1900:4030::
    Azure:  40.126.0.0
            2a01:111:f403:f910::
    Private: 127.1.2.7
            ::1
------------------------------------------------------------------------------------------ -->
<title>Lookup Cloud IP</title>
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<style>
body {
    background:#272822;
    color:#f8f8f2;
    font-family:Menlo,Monaco,Consolas,monospace;
    font-size:12pt;
}
a {
    color:#a8a8f2;
    text-decoration:none;
}
a:hover{
    color:#a8a8f2;
    text-decoration:underline;
}
.note {
    font-size: 80%;
    color: #888;
}
input[type=button],input[type=submit],input[type=reset] {
    background-color: #444;
    border: none;
    color: #f8f8f2;
    padding: 2pt 20pt;
    text-decoration: none;
    cursor: pointer;
    font-family: Menlo,Monaco,Consolas,monospace;
    font-size: 12pt;
    -webkit-appearance: none;
}
input[type="text"],input[type="number"],textarea {
    background-color: #000;
    color: #cec;
    font-family: Menlo,Monaco,Consolas,monospace;
    font-size: 12pt;
    border-top-style: hidden;
    border-right-style: hidden;
    border-left-style: hidden;
    border-bottom-style: solid;
    border-bottom-width: 1px;
    border-bottom-color: #a8a8f2;
    padding: 2px;
}
input[type="text"],input[type="number"],textarea:focus {
    outline: none;
}
</style>
<script src="cidr_helper.min.js"></script>
<script>
var db = null;
var left_to_load = 2;

function done_loading() {
    left_to_load--;
    if (left_to_load == 0) {
        var len = db[26];
        var temp = "";
        for (var x = 0; x < len; x++) {
            temp += String.fromCharCode(db[27+x]);
        }
        document.getElementById("last_updated").innerHTML = "Database last updated: " + temp;
        helper = function() {
            document.getElementById('results').innerHTML = lookup(document.getElementById('ip').value);
        };
        document.getElementById('ip').oninput = helper;
        helper();
    }
}

function fetch_error(response) {
    if (!response.ok) {
        throw Error(response.status + " (" + response.statusText + ")");
    }
    return response;
}

function show_error(error) {
    document.getElementById("errors").innerHTML += "ERROR: Unable to load database: " + error.message + "<br>"
    done_loading();
}

fetch("https://raw.githubusercontent.com/seligman/cloud_sizes/master/data/cloud_db.dat")
    .then(fetch_error)
    .then(response => response.blob())
    .then(blob => blob.arrayBuffer())
    .then(buffer => {
        db = new Uint8Array(buffer);
        done_loading();
    })
    .catch((error) => {
        db = null;
        show_error(error)
    });

function lookup(ip) {
    ip = ip.trim();
    if (ip.length == 0) {
        return "-";
    }

    try {
        ip = ipToBits(ip);
    } catch(e) {
        return "(invalid IP)";
    }

    if (ip.length == 32) {
        ip = '0' + ip;
    } else {
        ip = '1' + ip;
    }

    var fieldSize = db[24];
    var offset = 128 * 2;

    for (var i = 0; i < ip.length; i++) {
        if (ip[i] === "1") { offset += fieldSize * 2; }
        offset >>= 1;
        var val = 0;
        for (var x = 0; x < fieldSize; x++) {
            val = (val << 8) | db[offset+x];
        }
        offset = val;
        if ((offset % 2) == 1) {
            break;
        }
    }

    offset >>= 1;
    var val = (db[offset] << 8) | db[offset+1];

    if (val == 0) {
        return "(unknown IP)";
    }

    offset += 2;
    var item = [''];
    var items = [item];

    for (var x = 0; x < val; x++) {
        if (db[offset+x] == 1) {
            item = ['']
            items.push(item);
        } else if (db[offset+x] == 0) {
            item.push('');
        } else {
            item[item.length-1] += String.fromCharCode(db[offset+x]);
        }
    }

    var ret = '';
    items.forEach(item => {
        var temp = cidrToIPs(item[3]);
        ret += "Prefix: " + item[3];
        if (temp[0] === temp[1]) {
            ret += " <i>(" + temp[0] + ")</i><br>";
        } else {
            ret += " <i>(" + temp[0] + " -&gt; " + temp[1] + ")</i><br>";
        }
        if (item[2].length > 0) {
            ret += "Region: " + item[2] + "<br>";
        }
        if (item[1].length > 0) {
            ret += "Service: " + item[1] + "<br>";
        }
        ret += "Source: " + item[0] + "<br>";
        ret += "<br>";
    });
    return ret;
}
</script>
</head>
<body onload="done_loading()">
<p>Enter an IP to lookup which service it comes from:</p>
<input type="text" size="40" id="ip" autocomplete="off" autocorrect="off">
<br><br>
<div id="results">Loading...</div><br>
<div id="errors"></div>
<div id="last_updated" class="note"></div>
<hr>
Or, you can <a href="https://github.com/seligman/seligman.github.io/blob/master/cloud-ips/lookup_ip_address.py">download a Python version of this tool</a>.
</body>
</html>
